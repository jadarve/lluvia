<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.98.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Camera undistort | Lluvia</title><meta name=description content="Presents new nodes for undistorting images given a camera calibration model with radial and tangential distortion."><meta property="og:title" content="Camera undistort"><meta property="og:description" content="Presents new nodes for undistorting images given a camera calibration model with radial and tangential distortion."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2022/09/18/camera-undistort/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-18T16:34:53-05:00"><meta property="og:site_name" content="Lluvia"><meta itemprop=name content="Camera undistort"><meta itemprop=description content="Presents new nodes for undistorting images given a camera calibration model with radial and tangential distortion."><meta itemprop=datePublished content="2022-09-18T00:00:00+00:00"><meta itemprop=dateModified content="2022-09-18T16:34:53-05:00"><meta itemprop=wordCount content="1991"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Camera undistort"><meta name=twitter:description content="Presents new nodes for undistorting images given a camera calibration model with radial and tangential distortion."><link rel=preload href=/scss/main.min.209ee91954d0f2f182770e6c71011a5580360636bcf2a9bcf7f1c3da478784ff.css as=style><link href=/scss/main.min.209ee91954d0f2f182770e6c71011a5580360636bcf2a9bcf7f1c3da478784ff.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2LVGWPRNS4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LVGWPRNS4",{anonymize_ip:!1})}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Lluvia</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/jadarve/lluvia target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/nodes/><span>Node Library</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/api/cpp/index.html><span>C++ API</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/api/python/index.html><span>Python API</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.871df1b43d548101b98b6e936b290064.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.871df1b43d548101b98b6e936b290064.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Docsy Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blogarticles-li><input type=checkbox id=m-blogarticles-check checked>
<label for=m-blogarticles-check><a href=/blog/articles/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogarticles><span>Articles</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20220918camera-undistort-li><input type=checkbox id=m-blog20220918camera-undistort-check checked>
<label for=m-blog20220918camera-undistort-check><a href=/blog/2022/09/18/camera-undistort/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20220918camera-undistort><span class=td-sidebar-nav-active-item>Camera undistort</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-li><input type=checkbox id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-check>
<label for=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-check><a href=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/ title="Implementing the Horn and Schunck optical flow algorithm" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm><span>Horn and Schunck optical flow algorithm.</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220212working-with-floating-point-precision-li><input type=checkbox id=m-blog20220212working-with-floating-point-precision-check>
<label for=m-blog20220212working-with-floating-point-precision-check><a href=/blog/2022/02/12/working-with-floating-point-precision/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220212working-with-floating-point-precision><span>Working with floating point precision</span></a></label></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/jadarve/lluvia/tree/main/content/en/blog/articles/2022-09-18_camera_undistort/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/jadarve/lluvia/edit/main/content/en/blog/articles/2022-09-18_camera_undistort/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/jadarve/lluvia/new/main/content/en/blog/articles/2022-09-18_camera_undistort/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/jadarve/lluvia/issues/new?title=Camera%20undistort" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/jadarve/lluvia/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#camera-model>Camera model</a></li><li><a href=#standard-distortion-model>Standard distortion model</a></li></ul></li><li><a href=#implementation>Implementation</a></li><li><a href=#runtime-performance>Runtime performance</a></li><li><a href=#discussion>Discussion</a></li><li><a href=#references>References</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Camera undistort</h1><div class=lead>Presents new nodes for undistorting images given a camera calibration model with radial and tangential distortion.</div><div class="td-byline mb-4">By <b>Juan Adarve</b> |
<time datetime=2022-09-18 class=text-muted>Sunday, September 18, 2022</time></div><header class=article-meta></header><div class="alert alert-primary" role=alert><h4 class=alert-heading>Jupyter notebook:</h4>A Jupyter notebook with the code in this article is available in <a href="https://colab.research.google.com/drive/1ZCuY7E904K7IdsI0FW2O13H_bYn-2LYJ?usp=sharing">Google Colab</a>. Check it out!</div><h2 id=background>Background</h2><p>Camera undistort is the process by which distortions generated by the optics used in the camera during the capture process are corrected in software. The process requires a mathematical model of the distortion, and a calibration procedure to estimate the parameters of such model given actual images.</p><p>An overview of the camera modeling is pressented in the Computer Vision book of <a href=https://szeliski.org/Book/>Szeliski</a> and the Multiple View Geometry book of <a href=https://www.cambridge.org/core/books/multiple-view-geometry-in-computer-vision/0B6F289C78B2B23F596CAA76D3D43F7A>Hartley and Zisserman</a>, as well as the articles of <a href=https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr98-71.pdf>Zhang</a>, <a href=https://doi.org/10.1109/34.291450>Wei and Ma</a>.</p><p>There are several calibration toolboxes available for estimating the camera model from a series of images:</p><ul><li><a href=https://docs.opencv.org/4.x/dc/dbb/tutorial_py_calibration.html>OpenCV calibration routines</a>.</li><li><a href=https://www.mathworks.com/help/vision/ref/cameracalibrator-app.html>Matlab camera calibration App</a>.</li></ul><p>Any of such frameworks can be used to estimate the camera model parameters. Those parameters are the input to the undistort method presented in this article to rectify raw captured images.</p><h3 id=camera-model>Camera model</h3><p>The figure below illustrates the camera model.</p><p><img src=camera_model.svg alt></p><p>The 3D point $\mathbf{x} \in \mathbb{R}^3$ is expressed relative to the camera body fixed frame. It projects onto the camera image plane as pixel $\mathbf{p} := (u, v)^\top \in \mathbb{R}^2$ as</p><p>$$
\begin{equation}
\begin{pmatrix}
\mathbf{p} \\
1
\end{pmatrix} := \begin{pmatrix}
u \\
v \\
1
\end{pmatrix} = \frac{\mathbf{K} \mathbf{x}}{ \left&lt; e_3, \mathbf{x} \right>}
\end{equation}
$$</p><p>where $\mathbf{K} \in \mathbb{R}^{3\times3}$ is the camera intrinsics matrix, $e_3 := (0, 0, 1)^\top$, and $\left&lt; e_3, \mathbf{x} \right>$ is the dot product between the two vectors. The units of $\mathbf{p}$ are actual pixel coordinates in the ranges $u \in [0, W)$ and $v \in [0, H)$, with $W$ and $H$ denoting the image width and height respectively.</p><p>Given a pixel point, the corresponding 3D coordinate $\bar{\mathbf{x}}$ in the image plane is defined as:</p><p>$$
\begin{equation}
\bar{\mathbf{x}} := \begin{pmatrix}
\bar{x} \\
\bar{y} \\
\bar{z} \\
\end{pmatrix} = \mathbf{K}^{-1} \begin{pmatrix}
\mathbf{p} \\
1
\end{pmatrix}
\end{equation}
$$</p><div class="alert alert-warning" role=alert>Notice that this projection does return $\bar{\mathbf{x}}$ and not the original 3D point $\mathbf{x}$. To return the actual 3D position in the world, the depth information is needed to project $\bar{\mathbf{x}}$ outside of the image plane to the world.</div><h3 id=standard-distortion-model>Standard distortion model</h3><p>The standard distortion model is formed by two components:</p><ul><li>A <strong>radial</strong> component parameterized by three coefficients: $k_1$, $k_2$, and $k_3$.</li><li>A <strong>tangential</strong> component with two parameters: $p_1$ and $p_2$.</li></ul><p>The radial distortion component for a given pixel $\mathbf{p}$ is computed as</p><p>$$
\begin{equation}
\bar{\mathbf{x}}_r :=
R \begin{pmatrix}
\bar{x} \\
\bar{y} \\
0
\end{pmatrix}
\end{equation}
$$</p><p>where $R \in \mathbb{R}$ is</p><p>$$
\begin{equation}
R = k_1 r^2 + k_2 r^4 + k_3 r^6
\end{equation}
$$</p><p>with</p><p>$$
\begin{equation}
r^2 = \bar{x}^2 + \bar{y}^2
\end{equation}
$$</p><p>and $\bar{x}, \bar{y}$ are the $x$ and $y$ coordinates of the projection of pixel $\mathbf{p}$ using equation (2).</p><p>The tangential distortion is computed as:</p><p>$$
\begin{equation}
\bar{\mathbf{x}}_p :=
\begin{pmatrix}
2 p_1 \bar{x}\bar{y} + p_2(r^2 + 2\bar{x}^2) \\
p_1(r^2 + 2 \bar{y}^2) + 2 p_2 \bar{x}\bar{y} \\
0
\end{pmatrix}
\end{equation}
$$</p><p>Finally, the undistorted image plane coordinates $\bar{\mathbf{x}}_u$ is computed as:</p><p>$$
\begin{equation}
\bar{\mathbf{x}}_u = \bar{\mathbf{x}} + \bar{\mathbf{x}}_r + \bar{\mathbf{x}}_p
\end{equation}
$$</p><p>Given $\bar{\mathbf{x}}_u$, the corresponding undistorted pixel coordinate is:</p><p>$$
\begin{equation}
\begin{pmatrix}
\mathbf{p}_u \\
1
\end{pmatrix} := \begin{pmatrix}
u_u \\
v_u \\
1
\end{pmatrix} = \frac{\mathbf{K} \bar{\mathbf{x}}_u}{ \left&lt; e_3, \bar{\mathbf{x}}_u \right>}
\end{equation}
$$</p><div class="alert alert-primary" role=alert>The convention for the tangential parameters $p_1$ and $p_2$ is the same to that of OpenCV. However, this convention is flipped to respect to that presented in the article of <em>Wei and Ma</em>.</div><p>The figures below illustrate the effects of the radial and tangential distortion. A possitive value of $k_1$ creates a <strong>barrel</strong> effect, while a negative value generates a <strong>pincushion</strong> effect. For the tangential parameters, $p_1$ models missalignment between the image sensor and the image plane in the $y$ axis, while $p_2$ models such missalignment in the $x$ axis.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1090px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/barrel_hu50158db2a2211989e3567bbd09d87fee_83263_1080x432_resize_catmullrom_3.png width=1080 height=432><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1090px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/pincushion_hu4c39888b16645a417e090a250a8a92a0_88415_1080x432_resize_catmullrom_3.png width=1080 height=432><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1090px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/tangent_p1_hu10d855f00f7694d9886eccb2aa825202_88297_1080x432_resize_catmullrom_3.png width=1080 height=432><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1090px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/tangent_p2_hudf879045f85972fbd42edc54ab395d40_84480_1080x432_resize_catmullrom_3.png width=1080 height=432><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><h2 id=implementation>Implementation</h2><p>The camera undistort procedure is implemented as a single <strong>ComputeNode</strong> with the following interface:</p><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
skinparam linetype ortho

state CameraUndistort as &#34;CameraUndistort_rgba8ui&#34; {

    state in_rgba &lt;&lt;inputPin&gt;&gt;
    state in_camera &lt;&lt;inputPin&gt;&gt;
    state out_rgba &lt;&lt;outputPin&gt;&gt;

}

note top of CameraUndistort
Parameters
----------
camera_model : int. Defaults to 0.
    The camera model used for rectifying the image. Possible values are:

    * 0: standard model
end note

@enduml
</code></pre><p>The node explicitly requires <code>rgba8ui</code> images to be bound to the node. The output <code>out_rgba</code> is allocated by the node. The <code>in_camera</code> is a <strong><code>UniformBuffer</code></strong> storing the camera model. This model is defined by the <code>ll_camera</code> struct in GLSL as:</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><a class="nav-link active tab-GLSL" id=tabs-7-0-tab data-toggle=tab href=#tabs-7-0 role=tab onclick='handleClick("GLSL")' aria-controls=tabs-7-0 aria-selected=true>GLSL</a></li></ul><div class=tab-content id=tabs-7-content><div class="tab-pane fade show active" id=tabs-7-0 role=tabpanel aria-labelled-by=tabs-7-0-tab><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#000;font-weight:700>struct</span> ll_camera {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// The camera intrinsic matrix. Used to project 3D points expressed in the camera coordinate frame</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// to the image plane and convert to pixel coordinates.</span>
</span></span><span style=display:flex><span>    mat3 K;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// The inverse camera intrinsic matrix. Used to convert from pixel to image plane coordinates.</span>
</span></span><span style=display:flex><span>    mat3 Kinv;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// Radial distortion coefficients. For the standard camera model,</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// only the first 3 coefficients are used (XYZ).</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>vec4</span> radialDistortion;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// Tangential distortion coefficients. Only the first 2 coefficients are used (XY).</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>vec4</span> tangentialDistortion;
</span></span><span style=display:flex><span>};</span></span></code></pre></td></tr></table></div></div></div></div><p>Uniform buffers are a special type of buffers used to store small data structures used in graphics and compute pipelines. The Vulkan tutorial on Uniform Buffers is a <a href=https://vulkan-tutorial.com/Uniform_buffers/Descriptor_layout_and_buffer>good read</a> on how they are used in general. Notice that the <code>ll_camera</code> uses GLSL types such as <code>mat3</code> and <code>vec4</code>. In the host CPU, one must use corresponding types and follow the byte alignmnet rules to make the buffer usable in the GPU. The alignment rules are defined by the <strong><code>STD140</code></strong> <a href=https://www.khronos.org/opengl/wiki/Interface_Block_(GLSL)>layout rules</a>. For the <code>ll_camera</code> struct, the <code>mat3</code> attributes must be transferred as a matrix of 4 rows and 3 columns in order to meet the alignment requirements.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Matrix storage in GLSL</h4>In GLSL, matrices are stored in <strong>column-major</strong> order. For a given matrix <code>M</code> indexed as <code>M[i, j]</code> where <code>i</code> and <code>j</code> are the row and column indexes, respectively, the elements <code>M[i, j]</code> and <code>M[i, j+1]</code> are stored contiguously in memory. This is different, for instance, to numpy&rsquo;s default ordering as <strong>row-major</strong>.</div><p>The code block below shows a complete example on how to run the <code>lluvia/camera/CameraUndistort_rgba8ui</code> node using a dummy camera model with radial and tangential distortion:</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><a class="nav-link active tab-Python" id=tabs-9-0-tab data-toggle=tab href=#tabs-9-0 role=tab onclick='handleClick("Python")' aria-controls=tabs-9-0 aria-selected=true>Python</a></li></ul><div class=tab-content id=tabs-9-content><div class="tab-pane fade show active" id=tabs-9-0 role=tabpanel aria-labelled-by=tabs-9-0-tab><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>lluvia</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>ll</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>lluvia.util</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>ll_util</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>numpy</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>np</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>matplotlib.pyplot</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>plt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>session <span style=color:#000;font-weight:700>=</span> ll<span style=color:#000;font-weight:700>.</span>createSession()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># memory to store the input and output images</span>
</span></span><span style=display:flex><span>memory <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createMemory(ll<span style=color:#000;font-weight:700>.</span>MemoryPropertyFlagBits<span style=color:#000;font-weight:700>.</span>DeviceLocal)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># memory to store the uniform buffer with the camera parameters</span>
</span></span><span style=display:flex><span>host_memory <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createMemory([ll<span style=color:#000;font-weight:700>.</span>MemoryPropertyFlagBits<span style=color:#000;font-weight:700>.</span>DeviceLocal,
</span></span><span style=display:flex><span>                                    ll<span style=color:#000;font-weight:700>.</span>MemoryPropertyFlagBits<span style=color:#000;font-weight:700>.</span>HostVisible,
</span></span><span style=display:flex><span>                                    ll<span style=color:#000;font-weight:700>.</span>MemoryPropertyFlagBits<span style=color:#000;font-weight:700>.</span>HostCoherent])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># read a sample image</span>
</span></span><span style=display:flex><span>sampleImage <span style=color:#000;font-weight:700>=</span> ll_util<span style=color:#000;font-weight:700>.</span>readSampleImage(<span style=color:#d14>&#39;koala&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># draw a grid on top of the sample image</span>
</span></span><span style=display:flex><span>Yrange <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>arange(<span style=color:#099>0</span>, sampleImage<span style=color:#000;font-weight:700>.</span>shape[<span style=color:#099>0</span>], <span style=color:#099>128</span>)
</span></span><span style=display:flex><span>Ylines <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>concatenate([n <span style=color:#000;font-weight:700>+</span> Yrange <span style=color:#000;font-weight:700>for</span> n <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>range</span>(<span style=color:#099>4</span>)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Xrange <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>arange(<span style=color:#099>0</span>, sampleImage<span style=color:#000;font-weight:700>.</span>shape[<span style=color:#099>1</span>], <span style=color:#099>128</span>)
</span></span><span style=display:flex><span>Xlines <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>concatenate([n <span style=color:#000;font-weight:700>+</span> Xrange <span style=color:#000;font-weight:700>for</span> n <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>range</span>(<span style=color:#099>4</span>)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sampleImage[Ylines, <span style=color:#000;font-weight:700>...</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>sampleImage[:, Xlines, <span style=color:#000;font-weight:700>...</span>] <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># the input image view must be sampled. This example uses nearest neighbor interpolation</span>
</span></span><span style=display:flex><span>in_rgba <span style=color:#000;font-weight:700>=</span> memory<span style=color:#000;font-weight:700>.</span>createImageViewFromHost(sampleImage,
</span></span><span style=display:flex><span>                                         filterMode<span style=color:#000;font-weight:700>=</span>ll<span style=color:#000;font-weight:700>.</span>ImageFilterMode<span style=color:#000;font-weight:700>.</span>Nearest,
</span></span><span style=display:flex><span>                                         addressMode<span style=color:#000;font-weight:700>=</span>ll<span style=color:#000;font-weight:700>.</span>ImageAddressMode<span style=color:#000;font-weight:700>.</span>Repeat,
</span></span><span style=display:flex><span>                                         normalizedCoordinates<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>False</span>,
</span></span><span style=display:flex><span>                                         sampled<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>###################################################</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Camera parameters</span>
</span></span><span style=display:flex><span>W <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>float</span>(in_rgba<span style=color:#000;font-weight:700>.</span>width)
</span></span><span style=display:flex><span>H <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>float</span>(in_rgba<span style=color:#000;font-weight:700>.</span>height)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Dummy camera matrix</span>
</span></span><span style=display:flex><span>K <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>array([[W, <span style=color:#099>0</span>, <span style=color:#099>0.5</span><span style=color:#000;font-weight:700>*</span>(W <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>)],
</span></span><span style=display:flex><span>              [<span style=color:#099>0</span>, H, <span style=color:#099>0.5</span><span style=color:#000;font-weight:700>*</span>(H <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>)],
</span></span><span style=display:flex><span>              [<span style=color:#099>0</span>, <span style=color:#099>0</span>, <span style=color:#099>1</span>] ], dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>float32, order<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;F&#39;</span>)
</span></span><span style=display:flex><span>Kinv <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>linalg<span style=color:#000;font-weight:700>.</span>inv(K)
</span></span><span style=display:flex><span>radialDistortion <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>array([<span style=color:#099>0.5</span>, <span style=color:#099>0</span>, <span style=color:#099>0</span>, <span style=color:#099>0</span>,], dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>float32)
</span></span><span style=display:flex><span>tangentialDistortion <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>array([<span style=color:#099>0.1</span>, <span style=color:#099>0</span>, <span style=color:#099>0</span>, <span style=color:#099>0</span>], dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>float32)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># align the matrices according to the STD140 rules (column major, 4-component vectors)</span>
</span></span><span style=display:flex><span>K_aligned <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>zeros((<span style=color:#099>4</span>,<span style=color:#099>3</span>), dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>float32, order<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;F&#39;</span>); K_aligned[:<span style=color:#099>3</span>, :<span style=color:#099>3</span>] <span style=color:#000;font-weight:700>=</span> K
</span></span><span style=display:flex><span>Kinv_aligned <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>zeros((<span style=color:#099>4</span>,<span style=color:#099>3</span>), dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>float32, order<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;F&#39;</span>); Kinv_aligned[:<span style=color:#099>3</span>, :<span style=color:#099>3</span>] <span style=color:#000;font-weight:700>=</span> Kinv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># create bytes buffer from matrices</span>
</span></span><span style=display:flex><span>buf <span style=color:#000;font-weight:700>=</span> K_aligned<span style=color:#000;font-weight:700>.</span>tobytes(order<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;F&#39;</span>) <span style=color:#000;font-weight:700>+</span> Kinv_aligned<span style=color:#000;font-weight:700>.</span>tobytes(order<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;F&#39;</span>) <span style=color:#000;font-weight:700>+</span> radialDistortion<span style=color:#000;font-weight:700>.</span>tobytes() <span style=color:#000;font-weight:700>+</span> tangentialDistortion<span style=color:#000;font-weight:700>.</span>tobytes()
</span></span><span style=display:flex><span>npBuf <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>frombuffer(buf, dtype<span style=color:#000;font-weight:700>=</span>np<span style=color:#000;font-weight:700>.</span>uint8)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># in_camera uniform buffer</span>
</span></span><span style=display:flex><span>in_camera <span style=color:#000;font-weight:700>=</span> host_memory<span style=color:#000;font-weight:700>.</span>createBufferFromHost(npBuf, usageFlags<span style=color:#000;font-weight:700>=</span>[ll<span style=color:#000;font-weight:700>.</span>BufferUsageFlagBits<span style=color:#000;font-weight:700>.</span>TransferSrc,
</span></span><span style=display:flex><span>                                                                ll<span style=color:#000;font-weight:700>.</span>BufferUsageFlagBits<span style=color:#000;font-weight:700>.</span>TransferDst,
</span></span><span style=display:flex><span>                                                                ll<span style=color:#000;font-weight:700>.</span>BufferUsageFlagBits<span style=color:#000;font-weight:700>.</span>UniformBuffer])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>###################################################</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Compute node</span>
</span></span><span style=display:flex><span>CameraUndistort <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createComputeNode(<span style=color:#d14>&#39;lluvia/camera/CameraUndistort_rgba8ui&#39;</span>)
</span></span><span style=display:flex><span>CameraUndistort<span style=color:#000;font-weight:700>.</span>setParameter(<span style=color:#d14>&#39;camera_model&#39;</span>, ll<span style=color:#000;font-weight:700>.</span>Parameter(<span style=color:#099>1</span>)) <span style=color:#998;font-style:italic># standard model</span>
</span></span><span style=display:flex><span>CameraUndistort<span style=color:#000;font-weight:700>.</span>bind(<span style=color:#d14>&#39;in_rgba&#39;</span>, in_rgba)
</span></span><span style=display:flex><span>CameraUndistort<span style=color:#000;font-weight:700>.</span>bind(<span style=color:#d14>&#39;in_camera&#39;</span>, in_camera)
</span></span><span style=display:flex><span>CameraUndistort<span style=color:#000;font-weight:700>.</span>init()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CameraUndistort<span style=color:#000;font-weight:700>.</span>run()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_rgba <span style=color:#000;font-weight:700>=</span> CameraUndistort<span style=color:#000;font-weight:700>.</span>getPort(<span style=color:#d14>&#39;out_rgba&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>###################################################</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Plotting</span>
</span></span><span style=display:flex><span>fig <span style=color:#000;font-weight:700>=</span> plt<span style=color:#000;font-weight:700>.</span>figure(figsize<span style=color:#000;font-weight:700>=</span>(<span style=color:#099>15</span>, <span style=color:#099>8</span>)); fig<span style=color:#000;font-weight:700>.</span>set_tight_layout(<span style=color:#000;font-weight:700>True</span>)
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>subplot2grid((<span style=color:#099>1</span>,<span style=color:#099>2</span>), (<span style=color:#099>0</span>,<span style=color:#099>0</span>)); plt<span style=color:#000;font-weight:700>.</span>imshow(in_rgba<span style=color:#000;font-weight:700>.</span>toHost()[<span style=color:#000;font-weight:700>...</span>, :<span style=color:#099>3</span>]); plt<span style=color:#000;font-weight:700>.</span>title(<span style=color:#d14>&#39;in_rgba&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>subplot2grid((<span style=color:#099>1</span>,<span style=color:#099>2</span>), (<span style=color:#099>0</span>,<span style=color:#099>1</span>)); plt<span style=color:#000;font-weight:700>.</span>imshow(out_rgba<span style=color:#000;font-weight:700>.</span>toHost()[<span style=color:#000;font-weight:700>...</span>, :<span style=color:#099>3</span>]); plt<span style=color:#000;font-weight:700>.</span>title(<span style=color:#d14>&#39;out_rgba&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>show()</span></span></code></pre></td></tr></table></div></div></div></div><p>Lines 36 to 60 create the uniform buffer containing the camera model. Lines 42 and 45 create the camera intrinsics matrix <code>K</code> and its inverse <code>Kinv</code>. Then, in lines 50-51, those matrices are aligned to meet the <code>std140</code> requirements; in this case, storing each matrix in a 4x3 matrix in column-major ordering (using <code>order='F'</code> in numpy). Finally, lines 54-55 concatenates all camera parameters to create a single numpy array <code>npBuf</code> which is then used to create the <code>in_camera</code> uniform buffer in lluvia.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1090px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/CameraUndistort_rgba8ui_hu7788cecf448c7281bfdd2d0147339e58_655674_1080x576_resize_catmullrom_3.png width=1080 height=576><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><h2 id=runtime-performance>Runtime performance</h2><p>A Razer Blade laptop running Ubuntu 22.04LTS was used for the runtime analysis. The laptop is equipped with an Intel i7-11800H processor, and the following Vulkan devices as reported by the code block below:</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><a class="nav-link active tab-Python" id=tabs-11-0-tab data-toggle=tab href=#tabs-11-0 role=tab onclick='handleClick("Python")' aria-controls=tabs-11-0 aria-selected=true>Python</a></li></ul><div class=tab-content id=tabs-11-content><div class="tab-pane fade show active" id=tabs-11-0 role=tabpanel aria-labelled-by=tabs-11-0-tab><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>lluvia</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>ll</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> dev <span style=color:#000;font-weight:700>in</span> ll<span style=color:#000;font-weight:700>.</span>getAvailableDevices():
</span></span><span style=display:flex><span>    <span style=color:#0086b3>print</span>(dev)</span></span></code></pre></td></tr></table></div></div></div></div><ul><li>NVIDIA GeForce RTX 3070 Laptop GPU.</li><li>Intel(R) UHD Graphics (TGL GT1).</li><li>llvmpipe (LLVM 13.0.1, 256 bits). This is a CPU implementation of the Vulkan API shipped with the <a href=https://docs.mesa3d.org/drivers/llvmpipe.html>Mesa drivers</a>.</li></ul><p>In addition, the <code>cv2.undistort()</code> function from OpenCV is considered for reference. Five resolutions are used in the evaluation: <code>VGA 640x480</code>, <code>HD 1280x720</code>, <code>FHD 1920x1080</code>, <code>WQHD 2560x1440</code>, and <code>UHD 3840x2160</code>. For each resolution, the algorithm is run for 1000 iterations and the median runtime is extracted. The figure and table belows show the runtime for each device and resolution combination.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1450px><img class=card-img-top src=/blog/2022/09/18/camera-undistort/runtime_hud6f35652faa5a6f16711e44a26b14da9_33910_1440x360_resize_catmullrom_3.png width=1440 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><table><thead><tr><th style=text-align:left>Resolution</th><th style=text-align:left>Device name</th><th style=text-align:right>Runtime median ms</th></tr></thead><tbody><tr><td style=text-align:left>VGA 640x480</td><td style=text-align:left>Intel UHD Graphics</td><td style=text-align:right>0.00235</td></tr><tr><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>0.013888</td></tr><tr><td style=text-align:left></td><td style=text-align:left>llvmpipe</td><td style=text-align:right>0.604263</td></tr><tr><td style=text-align:left></td><td style=text-align:left>OpenCV</td><td style=text-align:right>2.04252</td></tr><tr><td style=text-align:left>HD 1280x720</td><td style=text-align:left>Intel UHD Graphics</td><td style=text-align:right>0.007734</td></tr><tr><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>0.03728</td></tr><tr><td style=text-align:left></td><td style=text-align:left>llvmpipe</td><td style=text-align:right>1.50221</td></tr><tr><td style=text-align:left></td><td style=text-align:left>OpenCV</td><td style=text-align:right>6.38165</td></tr><tr><td style=text-align:left>FHD 1920x1080</td><td style=text-align:left>Intel UHD Graphics</td><td style=text-align:right>0.0151045</td></tr><tr><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>0.07456</td></tr><tr><td style=text-align:left></td><td style=text-align:left>llvmpipe</td><td style=text-align:right>3.17916</td></tr><tr><td style=text-align:left></td><td style=text-align:left>OpenCV</td><td style=text-align:right>17.1453</td></tr><tr><td style=text-align:left>WQHD 2560x1440</td><td style=text-align:left>Intel UHD Graphics</td><td style=text-align:right>0.0262145</td></tr><tr><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>0.109344</td></tr><tr><td style=text-align:left></td><td style=text-align:left>llvmpipe</td><td style=text-align:right>5.97528</td></tr><tr><td style=text-align:left></td><td style=text-align:left>OpenCV</td><td style=text-align:right>22.8469</td></tr><tr><td style=text-align:left>UHD 3840x2160</td><td style=text-align:left>Intel UHD Graphics</td><td style=text-align:right>0.058583</td></tr><tr><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>0.242688</td></tr><tr><td style=text-align:left></td><td style=text-align:left>llvmpipe</td><td style=text-align:right>17.6178</td></tr><tr><td style=text-align:left></td><td style=text-align:left>OpenCV</td><td style=text-align:right>49.477</td></tr></tbody></table><div class="alert alert-warning" role=alert><h4 class=alert-heading>Integrated vs Discrete GPU performance</h4>Notice that the Intel UHD Graphics device reports lower runtime than the discrete Nvidia RTX 3070 GPU. It is not clear why this is the case, as the Nvidia GPU has more compute resources than the Intel integrated graphics.</div><p>Also, notice how the <strong><code>llvmpipe</code></strong> CPU device is between three to four times faster than the <strong><code>OpenCV</code></strong> function. However, both CPU devices are 2 orders of magnitude slower than the <strong><code>Nvidia</code></strong> and <strong><code>Intel</code></strong> GPU devices.</p><h2 id=discussion>Discussion</h2><p>This post showed how to run the camera undistort node in Lluvia. The node takes as input an RGBA image and a camera model stored in a uniform buffer in the GPU, and produces an RGBA output image. The camera model stored in the uniform model must follow the GLSL std140 layout rules. In terms of runtime performance, the GPU implementation is several orders of magnitude faster than the OpenCV default implementation.</p><p>Future pieces of work includes:</p><ul><li>Expose the interpolation coordinates for undistorting the images as a new compute node. These coordinates could be cached in order to save computations on every node invocation.</li><li>Clip the undistorted image to a given area according to the camera model. This will be useful to avoid wasted pixels in the output, as shown in the examples.</li><li>Support for more image formats, such as <code>r8ui</code> and floating point channel types.</li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.opencv.org/4.x/dc/dbb/tutorial_py_calibration.html>OpenCV camera calibration routines</a>.</li><li><a href=https://www.mathworks.com/help/vision/ref/cameracalibrator-app.html>Matlab calibration app</a>.</li><li><a href=https://vulkan-tutorial.com/Uniform_buffers/Descriptor_layout_and_buffer>Vulkan tutorial on Uniform Buffers</a>.</li><li><a href=https://www.khronos.org/opengl/wiki/Interface_Block_(GLSL)>GLSL STD140 memory layout</a>.</li><li><a href=https://docs.mesa3d.org/drivers/llvmpipe.html>Mesa llvmpipe</a>.</li><li>Zhang, Z., 2000. A flexible new technique for camera calibration. IEEE Transactions on pattern analysis and machine intelligence, 22(11), pp.1330-1334. <a href=https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr98-71.pdf>Microsoft Technical Report</a>.</li><li>Wei, G.Q. and De Ma, S., 1994. Implicit and explicit camera calibration: Theory and experiments. IEEE Transactions on Pattern Analysis and Machine Intelligence, 16(5), pp.469-480. <a href=https://doi.org/10.1109/34.291450>DOI</a>.</li><li>Szeliski, R., 2010. Computer vision: algorithms and applications. Springer Science & Business Media. <a href=https://szeliski.org/Book/>Book</a>.</li><li>Hartley, R. and Zisserman, A., 2003. Multiple view geometry in computer vision. Cambridge university press. <a href=https://www.cambridge.org/core/books/multiple-view-geometry-in-computer-vision/0B6F289C78B2B23F596CAA76D3D43F7A>Book</a></li></ul><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/ aria-label="Previous - Implementing the Horn and Schunck optical flow algorithm" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a class="btn btn-primary disabled">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/jadarve/lluvia aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Lluvia Authors All Rights Reserved</small><p class=mt-2><a href=/docs/about/>About</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/deflate.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity="sha512-vJqxkZ+Sugf/6WRlpcxN01qVfX/29hF6qc33eHF1va3NgoV+U+wCi+uTAsQ10sDoGyBxHLdaHvGwDlV3yVYboA==" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity="sha512-5ufNcHqOYgilGEHPfuRIQ5B/vDS1M8+UC+DESZ5CwVgGTg+b2Ol/15rYL/GiCWJ/Sx8oVo0FPFok1dPk8U9INQ==" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity="sha512-ZA/RPrAo88DlwRnnoNVqKINnQNcWERzRK03PDaA4GIJiVZvGFIWQbdWCsUebMZfkWohnfngsDjXzU6PokO4jGw==" crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!0,left:"\\[",right:"\\\\]"}],errorcolor:"#CD5C5C",throwonerror:!0})'></script>
<script src=/js/main.min.2cb69594c0498924af40c4f0f58099e2e2884a1845881f3aefe417c92620cb4d.js integrity="sha256-LLaVlMBJiSSvQMTw9YCZ4uKIShhFiB867+QXySYgy00=" crossorigin=anonymous></script></body></html>