<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.98.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Implementing the Horn and Schunck optical flow algorithm | Lluvia</title><meta name=description content="GPU implementation of Horn and Schunck's variational method for estimating optical flow."><meta property="og:title" content="Implementing the Horn and Schunck optical flow algorithm"><meta property="og:description" content="GPU implementation of Horn and Schunck's variational method for estimating optical flow."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/"><meta property="og:image" content="/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/featured_Hydrangea.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-08-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-08T13:10:54-05:00"><meta property="og:site_name" content="Lluvia"><meta itemprop=name content="Implementing the Horn and Schunck optical flow algorithm"><meta itemprop=description content="GPU implementation of Horn and Schunck's variational method for estimating optical flow."><meta itemprop=datePublished content="2022-08-07T00:00:00+00:00"><meta itemprop=dateModified content="2022-10-08T13:10:54-05:00"><meta itemprop=wordCount content="1758"><meta itemprop=image content="/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/featured_Hydrangea.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/featured_Hydrangea.png"><meta name=twitter:title content="Implementing the Horn and Schunck optical flow algorithm"><meta name=twitter:description content="GPU implementation of Horn and Schunck's variational method for estimating optical flow."><link rel=preload href=/scss/main.min.209ee91954d0f2f182770e6c71011a5580360636bcf2a9bcf7f1c3da478784ff.css as=style><link href=/scss/main.min.209ee91954d0f2f182770e6c71011a5580360636bcf2a9bcf7f1c3da478784ff.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2LVGWPRNS4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LVGWPRNS4",{anonymize_ip:!1})}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Lluvia</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/jadarve/lluvia target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/nodes/><span>Node Library</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/api/cpp/index.html><span>C++ API</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/api/python/index.html><span>Python API</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.954c1b1cfcaa40b8cae60083ad855f6e.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.954c1b1cfcaa40b8cae60083ad855f6e.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Docsy Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blogarticles-li><input type=checkbox id=m-blogarticles-check checked>
<label for=m-blogarticles-check><a href=/blog/articles/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogarticles><span>Articles</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221128raspberry-pi-4-build-li><input type=checkbox id=m-blog20221128raspberry-pi-4-build-check>
<label for=m-blog20221128raspberry-pi-4-build-check><a href=/blog/2022/11/28/raspberry-pi-4-build/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221128raspberry-pi-4-build><span>Raspberry Pi 4 build</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221108android-integration-using-mediapipe-li><input type=checkbox id=m-blog20221108android-integration-using-mediapipe-check>
<label for=m-blog20221108android-integration-using-mediapipe-check><a href=/blog/2022/11/08/android-integration-using-mediapipe/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221108android-integration-using-mediapipe><span>Android integration using mediapipe</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221008mediapipe-integration-li><input type=checkbox id=m-blog20221008mediapipe-integration-check>
<label for=m-blog20221008mediapipe-integration-check><a href=/blog/2022/10/08/mediapipe-integration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221008mediapipe-integration><span>Mediapipe integration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220918camera-undistort-li><input type=checkbox id=m-blog20220918camera-undistort-check>
<label for=m-blog20220918camera-undistort-check><a href=/blog/2022/09/18/camera-undistort/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220918camera-undistort><span>Camera undistort</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-li><input type=checkbox id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-check checked>
<label for=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm-check><a href=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/ title="Implementing the Horn and Schunck optical flow algorithm" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20220807implementing-the-horn-and-schunck-optical-flow-algorithm><span class=td-sidebar-nav-active-item>Horn and Schunck optical flow algorithm.</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220212working-with-floating-point-precision-li><input type=checkbox id=m-blog20220212working-with-floating-point-precision-check>
<label for=m-blog20220212working-with-floating-point-precision-check><a href=/blog/2022/02/12/working-with-floating-point-precision/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220212working-with-floating-point-precision><span>Working with floating point precision</span></a></label></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/jadarve/lluvia/tree/main/content/en/blog/articles/2022-08-07_horn_schunck/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/jadarve/lluvia/edit/main/content/en/blog/articles/2022-08-07_horn_schunck/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/jadarve/lluvia/new/main/content/en/blog/articles/2022-08-07_horn_schunck/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/jadarve/lluvia/issues/new?title=Implementing%20the%20Horn%20and%20Schunck%20optical%20flow%20algorithm" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/jadarve/lluvia/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#minimization>Minimization</a></li></ul></li><li><a href=#implementation>Implementation</a></li><li><a href=#evaluation-on-the-middlebury-dataset>Evaluation on the Middlebury dataset</a></li><li><a href=#runtime-performance>Runtime performance</a></li><li><a href=#discussion>Discussion</a></li><li><a href=#references>References</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Implementing the Horn and Schunck optical flow algorithm</h1><div class=lead>GPU implementation of Horn and Schunck&rsquo;s variational method for estimating optical flow.</div><div class="td-byline mb-4">By <b>Juan Adarve</b> |
<time datetime=2022-08-07 class=text-muted>Sunday, August 07, 2022</time></div><header class=article-meta></header><div class="alert alert-primary" role=alert><h4 class=alert-heading>Jupyter notebook:</h4>A Jupyter notebook with the code in this article is available in <a href="https://colab.research.google.com/drive/1SPwxUIdYxCALD0d0w7rE93EuX0fm832S?usp=sharing">Google Colab</a>. Check it out!</div><h2 id=background>Background</h2><p>The <a href="https://scholar.google.com/citations?view_op=view_citation&hl=en&user=uWsBKQ0AAAAJ&citation_for_view=uWsBKQ0AAAAJ:u5HHmVD_uO8C">Horn and Schunck</a> variational method for computing optical flow is one of the seminal works in the field. It introduces the idea of using a global smoothness constrain on the estimated optical flow. This constrain helps the numerical solution to find a good flow estimate even in image regions with poor texture.</p><p>Let $\mathbf{E}(x, y, t)$ be the image brightness at point $(x, y)$ and time $t$. Considering the constant brightness assumption, where the change in brightness is zero, that is,</p><p>$$
\frac{d \mathbf{E}}{d t} = 0
$$</p><p>Taking the partial derivatives over $(x, y, t)$, one has:</p><p>$$
\frac{\partial \mathbf{E}}{\partial x} \frac{\partial x}{\partial t} + \frac{\partial \mathbf{E}}{\partial y} \frac{\partial y}{\partial t} + \frac{\partial \mathbf{E}}{\partial t} = 0
$$</p><p>For convenience, let:</p><p>$$
\begin{align*}
\mathbf{E}_x &= \frac{\partial \mathbf{E}}{\partial x} \\
\mathbf{E}_y &= \frac{\partial \mathbf{E}}{\partial y} \\
\mathbf{E}_t &= \frac{\partial \mathbf{E}}{\partial t}
\end{align*}
$$</p><p>be the image gradient in the $x$ and $y$ directions, and the partial derivative in time, respectively, and</p><p>$$
\begin{align}
u &= \frac{\partial x}{\partial t} \\
v &= \frac{\partial y}{\partial t}
\end{align}
$$</p><p>be the $x$ and $y$ components of the optical flow, respectively. The constant brightness equation is then</p><p>$$
\mathbf{E}_x u + \mathbf{E}_y v + \mathbf{E}_t = 0
$$</p><p>which is the basis for the differential methods for computing optical flow (e.g. Lukas-Kanade).</p><h3 id=minimization>Minimization</h3><p>Differential methods for estimating optical flow try to minimize the cost function</p><p>$$
\epsilon_b = \mathbf{E}_x u + \mathbf{E}_y v + \mathbf{E}_t
$$</p><p>that is, to try to find values $(u, v)$ of the optical flow such that the constant brightness constrain is maintained. Notice that there is a single cost funcion and two unknowns $(u, v)$. To solve this, the Horn and Schunck algorithm adds a smoothness constrain based on the average value of the flow in a neighborhood, as</p><p>$$
\epsilon_c^2 = (\bar{u} - u )^2 + (\bar{v} - v)^2
$$</p><p>Combining both cost functions, one has</p><p>$$
\epsilon^2 = \alpha^2 \epsilon_b^2 + \epsilon_c^2
$$</p><p>From these equations, a numerical solution is derived. The reader is encouraged to go to the <a href="https://scholar.google.com/citations?view_op=view_citation&hl=en&user=uWsBKQ0AAAAJ&citation_for_view=uWsBKQ0AAAAJ:u5HHmVD_uO8C">paper</a> for more details. The iterative solution for $(u, v)$ is</p><p>$$
\begin{align*}
u^{n+1} &= \bar{u}^n - \mathbf{E}_x \frac{\mathbf{E}_x \bar{u}^n + \mathbf{E}_y \bar{v}^n + \mathbf{E}_t}{\alpha^2 + \mathbf{E}_x^2 + \mathbf{E}_y^2} \\
v^{n+1} &= \bar{v}^n - \mathbf{E}_y \frac{\mathbf{E}_x \bar{u}^n + \mathbf{E}_y \bar{v}^n + \mathbf{E}_t}{\alpha^2 + \mathbf{E}_x^2 + \mathbf{E}_y^2}
\end{align*}
$$</p><p>where $(u^{n+1}, v^{n+1})$ is the estimated optical flow at iteration $n + 1$, using the estimated flow at previous iterations and image parameters computed from an image pair.</p><h2 id=implementation>Implementation</h2><p>The figure below illustrates the pipeline implementing the algorithm:</p><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
skinparam linetype ortho

state HS as &#34;HornSchunck&#34; {

  state in_gray &lt;&lt;inputPin&gt;&gt;

  state ImageProcessor
  state ImageNormalize_uint_C1

  state NI_1 as &#34;NumericIteration 1&#34;
  state NI_2 as &#34;NumericIteration 2&#34;
  state NI_3 as &#34;NumericIteration 3&#34;
  state NI_N as &#34;NumericIteration N&#34;
  
  in_gray -down-&gt; ImageProcessor
  in_gray -down-&gt; ImageNormalize_uint_C1
  
  
  ImageNormalize_uint_C1 -down-&gt; ImageProcessor: in_gray_old
  
  ImageProcessor -down-&gt; NI_1: in_image_params
  ImageProcessor -down-&gt; NI_2
  ImageProcessor -down-&gt; NI_3
  ImageProcessor -down-&gt; NI_N: in_image_params
  
  NI_1 -&gt; NI_2
  NI_2 -&gt; NI_3
  NI_3 -&gt; NI_N: ...
  NI_N -&gt; NI_1: in_flow, used for next image iteration
  
  NI_N -down-&gt; out_flow &lt;&lt;outputPin&gt;&gt;
  ImageNormalize_uint_C1 -down&gt; out_gray &lt;&lt;outputPin&gt;&gt;
}

note top of HS
Parameters
----------
alpha : float. Defaults to 0.05.
    Regularization gain.

iterations : int. Defaults to 1.
    Number of iterations run to compute the optical flow.

float_precision : int. Defaults to ll.FloatPrecision.FP32.
    Floating point precision used accross the algorithm. The outputs out_gray
    and out_flow will be of this floating point precision.
end note
@enduml
</code></pre><p>The <strong><code>HornSchunck</code></strong> is a <em>ContainerNode</em> that instantiates several <em>ComputeNode</em> implementing the algorithm. In particular, the <strong><code>ImageProcessor</code></strong> node computes image parameters from the pair of images <code>in_gray</code> and <code>in_gray_old</code>. Those parameters are transfered to the instances of <strong><code>NumericIteration</code></strong> through <code>in_image_params</code>, organized as follows:</p><ul><li><code>in_image_params.x</code>: X component of the image gradient</li><li><code>in_image_params.y</code>: Y component of the image gradient</li><li><code>in_image_params.z</code>: temporal derivative between <code>in_gray</code> and <code>in_gray_old</code>.</li><li><code>in_image_params.w</code>: gain for this pixel computed from image gradient and <code>alpha</code> parameter.</li></ul><p>This packaging of the image parameters is convenient as all values are packed together in a singe RGBA pixel. The floating point precision of this, and the estimated optical flow is controlled by the <code>float_precision</code> parameter.</p><p>The <strong><code>NumericIteration</code></strong> node takes the image parameters and a prior estimation of the optical flow, <code>in_flow</code>, and computes the next iteration of the flow field. The algorithm requires several iterations for the estimated flow to be of acceptable quality. In the figure above, the last iteration is denoted as <code>NumericIteration_N</code> and it feeds its output back as input to the first one, as well as the output of the <strong><code>HornSchunck</code></strong> node. The number of iterations is controlled by the <code>iterations</code> parameter.</p><p>The code block below shows how to run a simple pipeline:</p><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
skinparam linetype ortho

state RGBA2Gray
state HS as &#34;HornSchunck&#34;
state Flow2RGBA

RGBA2Gray -down-&gt; HS: in_gray
HS -down-&gt; Flow2RGBA: in_flow
@enduml
</code></pre><p>where <strong><code>RGBA2Gray</code></strong> converts an input RGBA image to gray scale, <strong><code>HornSchunck</code></strong> computes the optical flow, and <strong><code>Flow2RGBA</code></strong> converts the optical flow to color representation.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><a class="nav-link active tab-Python" id=tabs-1-0-tab data-toggle=tab href=#tabs-1-0 role=tab onclick='handleClick("Python")' aria-controls=tabs-1-0 aria-selected=true>Python</a></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade show active" id=tabs-1-0 role=tabpanel aria-labelled-by=tabs-1-0-tab><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>lluvia</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>ll</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>lluvia.util</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>ll_util</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>matplotlib.pyplot</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>plt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># read two images as numpy arrays</span>
</span></span><span style=display:flex><span>frame_0 <span style=color:#000;font-weight:700>=</span> ll_util<span style=color:#000;font-weight:700>.</span>readRGBA(<span style=color:#d14>&#39;path to first image...&#39;</span>)
</span></span><span style=display:flex><span>frame_1 <span style=color:#000;font-weight:700>=</span> ll_util<span style=color:#000;font-weight:700>.</span>readRGBA(<span style=color:#d14>&#39;path to second image...&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># global session and memory objects</span>
</span></span><span style=display:flex><span>session <span style=color:#000;font-weight:700>=</span> ll<span style=color:#000;font-weight:700>.</span>createSession()
</span></span><span style=display:flex><span>memory <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createMemory(ll<span style=color:#000;font-weight:700>.</span>MemoryPropertyFlagBits<span style=color:#000;font-weight:700>.</span>DeviceLocal)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># this is the input of the comple pipeline</span>
</span></span><span style=display:flex><span>in_rgba <span style=color:#000;font-weight:700>=</span> memory<span style=color:#000;font-weight:700>.</span>createImageViewFromHost(frame_0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RGBA2Gray <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createComputeNode(<span style=color:#d14>&#39;lluvia/color/RGBA2Gray&#39;</span>)
</span></span><span style=display:flex><span>RGBA2Gray<span style=color:#000;font-weight:700>.</span>bind(<span style=color:#d14>&#39;in_rgba&#39;</span>, in_rgba)
</span></span><span style=display:flex><span>RGBA2Gray<span style=color:#000;font-weight:700>.</span>init()
</span></span><span style=display:flex><span>RGBA2Gray<span style=color:#000;font-weight:700>.</span>run() <span style=color:#998;font-style:italic># run the node immediately in order to populate out_gray with valid values</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>in_gray <span style=color:#000;font-weight:700>=</span> RGBA2Gray<span style=color:#000;font-weight:700>.</span>getPort(<span style=color:#d14>&#39;out_gray&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HornSchunck <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createContainerNode(<span style=color:#d14>&#39;lluvia/opticalflow/HornSchunck/HornSchunck&#39;</span>)
</span></span><span style=display:flex><span>HornSchunck<span style=color:#000;font-weight:700>.</span>setParameter(<span style=color:#d14>&#39;alpha&#39;</span>, ll<span style=color:#000;font-weight:700>.</span>Parameter(<span style=color:#099>0.05</span>))
</span></span><span style=display:flex><span>HornSchunck<span style=color:#000;font-weight:700>.</span>setParameter(<span style=color:#d14>&#39;iterations&#39;</span>, ll<span style=color:#000;font-weight:700>.</span>Parameter(<span style=color:#099>1000</span>))
</span></span><span style=display:flex><span>HornSchunck<span style=color:#000;font-weight:700>.</span>setParameter(<span style=color:#d14>&#39;float_precision&#39;</span>, ll<span style=color:#000;font-weight:700>.</span>Parameter(ll<span style=color:#000;font-weight:700>.</span>FloatPrecision<span style=color:#000;font-weight:700>.</span>FP32<span style=color:#000;font-weight:700>.</span>value))
</span></span><span style=display:flex><span>HornSchunck<span style=color:#000;font-weight:700>.</span>bind(<span style=color:#d14>&#39;in_gray&#39;</span>, in_gray)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># when the node is initialized, it transfers the content of in_gray to out_gray.</span>
</span></span><span style=display:flex><span>HornSchunck<span style=color:#000;font-weight:700>.</span>init()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_gray <span style=color:#000;font-weight:700>=</span> HornSchunck<span style=color:#000;font-weight:700>.</span>getPort(<span style=color:#d14>&#39;out_gray&#39;</span>)
</span></span><span style=display:flex><span>out_flow <span style=color:#000;font-weight:700>=</span> HornSchunck<span style=color:#000;font-weight:700>.</span>getPort(<span style=color:#d14>&#39;out_flow&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Convert the optical flow field to color images</span>
</span></span><span style=display:flex><span>flow2RGBA <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createComputeNode(<span style=color:#d14>&#39;lluvia/viz/Flow2RGBA&#39;</span>)
</span></span><span style=display:flex><span>flow2RGBA<span style=color:#000;font-weight:700>.</span>setParameter(<span style=color:#d14>&#39;max_flow&#39;</span>, ll<span style=color:#000;font-weight:700>.</span>Parameter(<span style=color:#0086b3>float</span>(<span style=color:#099>2</span>)))
</span></span><span style=display:flex><span>flow2RGBA<span style=color:#000;font-weight:700>.</span>bind(<span style=color:#d14>&#39;in_flow&#39;</span>, out_flow)
</span></span><span style=display:flex><span>flow2RGBA<span style=color:#000;font-weight:700>.</span>init()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_flow_rgba <span style=color:#000;font-weight:700>=</span> flow2RGBA<span style=color:#000;font-weight:700>.</span>getPort(<span style=color:#d14>&#39;out_rgba&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>duration <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createDuration()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Record the command buffer to run the pipeline in one go</span>
</span></span><span style=display:flex><span>cmdBuffer <span style=color:#000;font-weight:700>=</span> session<span style=color:#000;font-weight:700>.</span>createCommandBuffer()
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>begin()
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>run(RGBA2Gray)
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>memoryBarrier()
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>durationStart(duration) <span style=color:#998;font-style:italic># start recording the duration to measure runtime</span>
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>run(HornSchunck)
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>memoryBarrier()
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>durationEnd(duration)   <span style=color:#998;font-style:italic># stop recording duration</span>
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>run(flow2RGBA)
</span></span><span style=display:flex><span>cmdBuffer<span style=color:#000;font-weight:700>.</span>end()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># copy the content of the second frame to the in_rgba image before running the whole pipeline</span>
</span></span><span style=display:flex><span>in_rgba<span style=color:#000;font-weight:700>.</span>fromHost(frame_1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># run the pipeline</span>
</span></span><span style=display:flex><span>session<span style=color:#000;font-weight:700>.</span>run(cmdBuffer)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># print runtime in milliseconds</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>print</span>(<span style=color:#d14>&#39;</span><span style=color:#d14>{0:.02f}</span><span style=color:#d14> ms&#39;</span><span style=color:#000;font-weight:700>.</span>format(duration<span style=color:#000;font-weight:700>.</span>nanoseconds <span style=color:#000;font-weight:700>/</span> <span style=color:#099>1e6</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fig <span style=color:#000;font-weight:700>=</span> plt<span style=color:#000;font-weight:700>.</span>figure(figsize<span style=color:#000;font-weight:700>=</span>(<span style=color:#099>10</span>, <span style=color:#099>6</span>)); fig<span style=color:#000;font-weight:700>.</span>set_tight_layout(<span style=color:#000;font-weight:700>True</span>)
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>subplot2grid((<span style=color:#099>1</span>,<span style=color:#099>2</span>), (<span style=color:#099>0</span>, <span style=color:#099>0</span>)); plt<span style=color:#000;font-weight:700>.</span>imshow(out_gray<span style=color:#000;font-weight:700>.</span>toHost(), vmin<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span>, vmax<span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span>, cmap<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;gray&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>subplot2grid((<span style=color:#099>1</span>,<span style=color:#099>2</span>), (<span style=color:#099>0</span>, <span style=color:#099>1</span>)); plt<span style=color:#000;font-weight:700>.</span>imshow(out_flow_rgba<span style=color:#000;font-weight:700>.</span>toHost())
</span></span><span style=display:flex><span>plt<span style=color:#000;font-weight:700>.</span>show()</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=evaluation-on-the-middlebury-dataset>Evaluation on the Middlebury dataset</h2><p>The <a href=https://vision.middlebury.edu/flow/>Middlebury optical flow dataset</a> from <a href="https://scholar.google.com/scholar?cluster=5697474256105237450&hl=en&as_sdt=0,5"><em>Baker et. al.</em></a> provides several real-life and synthetic image sequences with ground truth optical flow. The figures below shows the estimated optical flow for the test sequences whose ground truth is available.</p><p>The Horn ans Schunck algorithm is not well suited for large pixel displacements. Considering this, the input images are scaled to half before entering the compute pipeline. The ground truth flow is scaled accordingly in order to be compared with the estimated flow. The <em>Endpoint Error</em> measures the different in magnitude between the ground truth and the estimation, it is computed as:</p><p>$$
EE = \sqrt{(u - u_\text{gt})^2 + (v - v_\text{gt})^2}
$$</p><p>The algorithm is configured as follows:</p><ul><li><code>alpha</code>: 15.0/255</li><li><code>iterations</code>: 2000</li><li><code>float_precision</code>: FP32</li></ul><p>In general, the estimated optical flow yields acceptable results in image regions with small displacements (e.g. Dimetrodon, Grove2, Hydrangea, and RubberWhale). In image regions with large displacements, the method is not able to compute a good results, as can be visualized in the Urban2 and Urban3 sequences.</p><p>The results reported in this post were run on a Razer Blade 2021 Laptop equipped with an Nvidia RTX 3070 GPU. The runtime is reported in the title of each figure, and is in the order of 20 milliseconds for most of the image sequences. Section <a href=#runtime-performance>runtime performance</a> evaluates the performance of the algorithm on different devices, resolutions, and floating point precisions.</p><p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Dimetrodon_hub61d6bce717e84d12b94ae8f19c44dbe_380986_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Grove2_huf062432bdcc4b0dee6f383ad9b4dc7d4_560879_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Grove3_huf8f2f775eb608ba44f616a33e50d448f_686186_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/featured_Hydrangea_huab2d08a346f77aac20a6565f5879c559_512825_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/RubberWhale_hud2733ea7a567c3bc1da0d8b4b35593bf_468171_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Urban2_huda8ebcbe92be0174982d6803f056b859_429284_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Urban3_hu5eb0d8c36b3a768e4992ae76fa94cb32_413470_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2170px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/Venus_hu82173b313be1466d9e83f77f2cb695e1_410178_2160x360_resize_catmullrom_3.png width=2160 height=360><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div></p><h2 id=runtime-performance>Runtime performance</h2><p>For the runtime analysis of the algorithm, two GPU devices were used:</p><ul><li>A Nvidia GTX 1080 Desktop GPU.</li><li>A Nvidia RTX 3070 Laptop GPU running on a Razer Blade 2021.</li></ul><p>The Horn and Schunck pipeline is configured using the same number of iterations used for the Middlebury evalatuon, that is, <code>iterations = 2000</code>. The pipeline is configured for 5 different image resolutions (<code>VGA 640x480</code>, <code>HD 1280x720</code>, <code>HD 1920x1080</code>, <code>WQHD 2560x1440</code>, <code>UHD 3840x2160</code>). For each resolution, the pipeline is run both using <code>FP16</code> and <code>FP32</code> floating point precision. The table and figure below show the runtime performance for each configuration.</p><table><thead><tr><th style=text-align:left>Resolution</th><th style=text-align:left>Float precision</th><th style=text-align:left>Device</th><th style=text-align:right>Runtime median (ms)</th></tr></thead><tbody><tr><td style=text-align:left>VGA 640x480</td><td style=text-align:left>FP16</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>68.8196</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>39.4354</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FP32</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>97.5005</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>63.6458</td></tr><tr><td style=text-align:left>HD 1280x720</td><td style=text-align:left>FP16</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>193.977</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>115.626</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FP32</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>279.538</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>175.635</td></tr><tr><td style=text-align:left>HD 1920x1080</td><td style=text-align:left>FP16</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>429.256</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>257.624</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FP32</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>623.555</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>386.718</td></tr><tr><td style=text-align:left>WQHD 2560x1440</td><td style=text-align:left>FP16</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>757.101</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>449.536</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FP32</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>1099.35</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>682.558</td></tr><tr><td style=text-align:left>UHD 3840x2160</td><td style=text-align:left>FP16</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>1694.16</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>1010.16</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FP32</td><td style=text-align:left>GTX 1080</td><td style=text-align:right>2453.45</td></tr><tr><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left>RTX 3070</td><td style=text-align:right>1551.34</td></tr></tbody></table><p>It is not surprising that the RTX 3070 GPU is faster than the GTX 1080, as the former is of a newer generation than the latter.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2010px><img class=card-img-top src=/blog/2022/08/07/implementing-the-horn-and-schunck-optical-flow-algorithm/runtime_hu8436b281ec8250665a25e3f2104e6842_65108_2000x500_resize_catmullrom_3.png width=2000 height=500><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><h2 id=discussion>Discussion</h2><p>This post presented a GPU implementation of the Horn and Schunck optical flow algorithm. Evaluation in the Middlebury test sequences show the validity of the implementation. A runtime performance analysis was conducted on two GPUs using several image resolutions and floatin point precisions.</p><p>Future work includes:</p><ul><li>Implementing a pyramidal scheme, for instance that of <a href="https://scholar.google.com/scholar?cluster=16090950858323308671&hl=en&as_sdt=0,5">Llopis <em>et. al.</em></a>, to improve the accuracy of the algorithm in presence of large displacements.</li><li>Use the smoothness constrain and numerical scheme in the <a href="https://scholar.google.com/scholar?cluster=8318694254870078457&hl=en&as_sdt=0,5">FlowFilter algorithm</a> to improve the accuracy.</li></ul><h2 id=references>References</h2><ul><li>Horn, Berthold KP, and Brian G. Schunck. &ldquo;Determining optical flow.&rdquo; Artificial intelligence 17.1-3 (1981): 185-203. <a href="https://scholar.google.com/citations?view_op=view_citation&hl=en&user=uWsBKQ0AAAAJ&citation_for_view=uWsBKQ0AAAAJ:u5HHmVD_uO8C">Google Scholar</a>.</li><li>Baker, S., Scharstein, D., Lewis, J.P., Roth, S., Black, M.J. and Szeliski, R., 2011. A database and evaluation methodology for optical flow. International journal of computer vision, 92(1), pp.1-31. <a href="https://scholar.google.com/scholar?cluster=5697474256105237450&hl=en&as_sdt=0,5">Google Scholar</a>.</li><li>Meinhardt-Llopis, E. and Sánchez, J., 2013. Horn-schunck optical flow with a multi-scale strategy. Image Processing on line. <a href="https://scholar.google.com/scholar?cluster=16090950858323308671&hl=en&as_sdt=0,5">Google Scholar</a></li><li>Adarve, Juan David, and Robert Mahony. &ldquo;A filter formulation for computing real time optical flow.&rdquo; IEEE Robotics and Automation Letters 1.2 (2016): 1192-1199. <a href="https://scholar.google.com/scholar?cluster=8318694254870078457&hl=en&as_sdt=0,5">Google Scholar</a></li></ul><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/02/12/working-with-floating-point-precision/ aria-label="Previous - Working with floating point precision" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a href=/blog/2022/09/18/camera-undistort/ aria-label="Next - Camera undistort" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/jadarve/lluvia aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Lluvia Authors All Rights Reserved</small><p class=mt-2><a href=/docs/about/>About</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/deflate.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity="sha512-vJqxkZ+Sugf/6WRlpcxN01qVfX/29hF6qc33eHF1va3NgoV+U+wCi+uTAsQ10sDoGyBxHLdaHvGwDlV3yVYboA==" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity="sha512-5ufNcHqOYgilGEHPfuRIQ5B/vDS1M8+UC+DESZ5CwVgGTg+b2Ol/15rYL/GiCWJ/Sx8oVo0FPFok1dPk8U9INQ==" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity="sha512-ZA/RPrAo88DlwRnnoNVqKINnQNcWERzRK03PDaA4GIJiVZvGFIWQbdWCsUebMZfkWohnfngsDjXzU6PokO4jGw==" crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!0,left:"\\[",right:"\\\\]"}],errorcolor:"#CD5C5C",throwonerror:!0})'></script>
<script src=/js/main.min.2cb69594c0498924af40c4f0f58099e2e2884a1845881f3aefe417c92620cb4d.js integrity="sha256-LLaVlMBJiSSvQMTw9YCZ4uKIShhFiB867+QXySYgy00=" crossorigin=anonymous></script></body></html>